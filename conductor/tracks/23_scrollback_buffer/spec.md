# Track: 23_scrollback_buffer 仕様書

## 概要
EmEditor ターミナルの利便性を向上させるため、過去の出力を遡って閲覧できるスクロールバック・バッファ（履歴バッファ）機能を実装する。
また、機能追加に先立ち、肥大化した `TerminalBuffer` から ANSI エスケープシーケンスの解析ロジックを分離し、保守性を向上させるリファクタリングを行う。

## アーキテクチャ変更 (Refactoring)
- **Parser の分離**
    - `TerminalBuffer` 内の入力解析ロジック（`write_string`, `handle_csi`, `handle_sgr` 等）を `src/domain/parser.rs` (新規) へ移動する。
    - `Parser` 構造体を定義し、入力ストリームの状態（不完全なシーケンス等）を管理させる。
    - `TerminalBuffer` は純粋な状態保持と、Parser からの指示による描画操作（文字配置、カーソル移動等）に専念する。
- **Application 層の導入**
    - `src/application/` モジュールを新設し、`TerminalService` を実装する。
    - `TerminalService` は `TerminalBuffer`, `AnsiParser`, `ConPTY` を統括し、GUI 層（`custom_bar.rs`）からの入力を処理する。
    - GUI 層はドメインロジックから分離され、描画とOSイベント処理に専念する。

## 機能要件
- **ヒストリーバッファの導入**
    - `TerminalBuffer` に画面外の行を保持する `history` (VecDeque) を追加。
    - 最大保持行数は **10,000行** とする。
    - 画面の最上行から押し出された行を自動的にヒストリーへ移動。
- **ビューポート概念の実装**
    - 現在表示している領域のオフセット（`viewport_offset`）を管理。
    - 描画時、`viewport_offset` に基づいてヒストリーとアクティブバッファから行を抽出して描画。
- **スクロールバー (SB_VERT) の制御**
    - ヒストリーの増分に合わせて Win32 スクロールバーの範囲（`SCROLLINFO`）をリアルタイムに更新。
    - `WM_VSCROLL` メッセージを処理し、スクロール操作（一行移動、一ページ移動、絶対位置移動）に対応。
- **インタラクション・ルール**
    - **入力時オートスクロール**: 履歴閲覧中にキー入力（文字、Enter等）があった場合、即座に最新行（最下部）へスクロールを戻す。
    - **出力時追従制御**:
        - スクロールが最下部にある状態で新しい出力があった場合は、自動的に追従してスクロールする。
        - ユーザーが手動でスクロールアップして過去を閲覧している間は、新しい出力があっても表示位置を維持する。
- **マウスホイール対応**
    - `WM_MOUSEWHEEL` を処理し、ホイール操作によるスクロールを可能にする。

## 非機能要件
- **メモリ効率**: 10,000行の保持時でも、動作に支障が出ない程度のメモリ使用量に抑える。
- **レンダリング性能**: スクロール操作時や大量出力時でも、描画がスムーズであることを維持する。

## 受入条件 (Acceptance Criteria)
- [ ] 画面外に消えた行がヒストリーに保存され、遡って表示できること。
- [ ] EmEditor のカスタムバーの垂直スクロールバーが、バッファ量に応じて適切に制御されること。
- [ ] スクロールバーのツマミをドラッグして、任意の位置の履歴を表示できること。
- [ ] 文字入力時に自動で最新行までスクロールが戻ること。
- [ ] 過去を表示中に新しいログが出ても、表示位置が勝手に動かないこと。
- [ ] マウスホイールで上下にスクロールできること。

## スコープ外
- スクロールバック・バッファ内のテキスト検索機能（別タスクで検討）。
- 履歴のファイル保存・エクスポート機能。
- スクロールバーのスタイルカスタマイズ。
