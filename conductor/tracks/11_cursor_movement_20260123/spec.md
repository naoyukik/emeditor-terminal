# トラック仕様書: 追加のカーソル移動シーケンスの実装

## 概要
高度なCLIアプリケーションをサポートするため、標準的なANSIカーソル移動シーケンス（`CHA`, `VPA`, `CNL`, `CPL`）を実装する。これらのシーケンスは、絶対的な水平/垂直位置指定、および行単位の相対移動を提供する。実装にあたっては、既存のカラム計算ロジックを使用して全角文字（CJK）を正しく処理する必要がある。

## 機能要件
1.  **`CHA` (Cursor Horizontal Absolute) の実装**
    *   シーケンス: `ESC [ <n> G`
    *   振る舞い: 現在の行の指定されたカラム `<n>` にカーソルを移動する。
    *   処理: `display_col_to_char_index` を使用して全角文字を考慮した文字インデックスに変換する。
2.  **`VPA` (Vertical Line Position Absolute) の実装**
    *   シーケンス: `ESC [ <n> d`
    *   振る舞い: 指定された行 `<n>` にカーソルを移動する（現在の表示カラム位置を維持）。
    *   処理: 新しい行のコンテンツに基づき、現在の表示カラムに対応する文字インデックスを `display_col_to_char_index` で再計算する。
3.  **`CNL` (Cursor Next Line) の実装**
    *   シーケンス: `ESC [ <n> E`
    *   振る舞い: カーソルを `<n>` 行下に移動し、行頭（カラム 1）に移動する。
4.  **`CPL` (Cursor Previous Line) の実装**
    *   シーケンス: `ESC [ <n> F`
    *   振る舞い: カーソルを `<n>` 行上に移動し、行頭（カラム 1）に移動する。

## 非機能要件
*   **パフォーマンス:** 既存の `TerminalBuffer` メソッド（`display_col_to_char_index` 等）を再利用し、オーバーヘッドを最小限に抑える。
*   **互換性:** これらのシーケンスに関するANSI標準の動作に従う。

## 実装詳細
*   **対象ファイル:** `src/domain/terminal.rs`
*   **対象メソッド:** `TerminalBuffer::handle_csi`
*   **パラメータ処理:**
    *   `<n>` が省略された場合、または無効（0）な場合はデフォルト値 `1` を使用する。
    *   バッファの境界（第1行、最終行、行末など）を超えないよう値をクランプする。
*   **全角文字サポート:**
    *   座標計算は全角（幅 2）と半角（幅 1）を考慮しなければならない。

## 受け入れ条件
*   [ ] `CHA` が全角文字を考慮し、正しい表示カラムに移動すること。
*   [ ] `VPA` が表示カラム位置を維持したまま、正しい行に移動すること。
*   [ ] `CNL` が指定行下に移動し、X 座標が 0 にリセットされること。
*   [ ] `CPL` が指定行上に移動し、X 座標が 0 にリセットされること。
*   [ ] すべてのシーケンスが画面境界で正しくクランプされること。
*   [ ] 以下の単体テストをパスすること:
    *   基本的な移動テスト。
    *   全角/半角混在行での移動テスト。
    *   境界値（上端、下端、左端、右端）での挙動テスト。
    *   既存機能への回帰テスト。

## スコープ外
*   上記にリストされていない他の未実装 CSI シーケンスの実装。
